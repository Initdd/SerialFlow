FROM ubuntu:24.04

# Install system dependencies matching the workflow
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
	libgl1-mesa-dev \
	libxkbcommon-x11-0 \
	libxcb-icccm4 \
	libxcb-image0 \
	libxcb-keysyms1 \
	libxcb-randr0 \
	libxcb-render-util0 \
	libxcb-xinerama0 \
	libxcb-xfixes0 \
	libglib2.0-0 \
	libdbus-1-3 \
	build-essential \
	python3 \
	python3-pip \
	python3-venv \
	git \
	wget

# Create a virtual environment for aqtinstall
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install aqtinstall to get Qt 6.10.1
RUN pip install aqtinstall

# Install Qt 6.10.1 (minimal minimal modules for QWidgets)
# Note: The 'archives' parameter might be needed if standard install fails, but let's try standard.
# Installing linux desktop 6.10.1 linux_gcc_64
RUN aqt install-qt linux desktop 6.10.1 linux_gcc_64 --outputdir /opt/qt -m qtserialport

# Add Qt to PATH
ENV PATH="/opt/qt/6.10.1/linux_gcc_64/bin:/opt/qt/6.10.1/gcc_64/bin:$PATH"

WORKDIR /app

CMD ["/bin/bash", "-c", "mkdir -p build && cd build && qmake /app/SerialFlow.pro && make"]

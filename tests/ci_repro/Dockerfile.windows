FROM ubuntu:24.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
# wine: runs windows executables
# mingw-w64: we might use it, but really we want windows binaries for consistency if using qmake.exe
# curl, wget, p7zip: for downloading tools
# python3: for aqtinstall
RUN dpkg --add-architecture i386 && \
	apt-get update && \
	apt-get install -y \
	wine \
	wine32 \
	wine64 \
	python3 \
	python3-pip \
	python3-venv \
	curl \
	wget \
	p7zip-full \
	git \
	--no-install-recommends

# Create venv for python tools
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install aqtinstall
RUN pip install aqtinstall

# Install Qt 6.10.1 for Windows (MinGW)
RUN aqt install-qt windows desktop 6.10.1 win64_mingw --outputdir /opt/qt -m qtserialport

# Download and install MinGW-w64 (Windows binaries)
# Qt 6.10.x likely uses GCC 13.1.0 or similar. We'll use a compatible one.
# Using niXman's build (msvcrt version to match Qt likely)
RUN wget -q https://github.com/niXman/mingw-builds-binaries/releases/download/13.2.0-rt_v11-rev0/x86_64-13.2.0-release-posix-seh-msvcrt-rt_v11-rev0.7z -O mingw.7z && \
	7z x mingw.7z -o/opt/mingw && \
	rm mingw.7z

# Setup Wine environment variables to include Qt and MinGW in PATH
# We translate linux paths to windows paths for Wine
ENV WINEPATH="Z:\\opt\\qt\\6.10.1\\mingw_64\\bin;Z:\\opt\\mingw\\mingw64\\bin"

# Disable wine debug messages
ENV WINEDEBUG=-all

WORKDIR /app

# Build script
# We run qmake then mingw32-make, then copy dependencies
CMD ["/bin/bash", "-c", "mkdir -p build-win-repro && cd build-win-repro && wine cmd /c 'qmake.exe ..\\SerialFlow.pro && mingw32-make.exe' && cp /opt/qt/6.10.1/mingw_64/bin/Qt6Core.dll /opt/qt/6.10.1/mingw_64/bin/Qt6Gui.dll /opt/qt/6.10.1/mingw_64/bin/Qt6Widgets.dll /opt/qt/6.10.1/mingw_64/bin/Qt6SerialPort.dll /opt/mingw/mingw64/bin/libgcc_s_seh-1.dll /opt/mingw/mingw64/bin/libstdc++-6.dll /opt/mingw/mingw64/bin/libwinpthread-1.dll release/"]
